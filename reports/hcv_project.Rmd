---
title: "Heterogeneity in HCV response at the single cell level"
author: "Health Data Science Unit"
date: "`r date()`"
output: 
    html_document:
            code_folding: hide
---

```{r setup, include=FALSE}
library(Matrix)
library(dplyr)
library(uwot)
library(ggplot2)
source("http://bioconductor.org/biocLite.R")
biocLite("GEOquery")
library(GEOquery)

knitr::opts_chunk$set(warning = FALSE,
                      message = FALSE,
                      cache = TRUE,
                      fig.width = 10,
                      fig.height = 7, 
                      echo = FALSE)
theme_set(theme_light())
```

## Hepatitis virus data

Eltahla A A et al, 2016 data of Ag-specific T cells from peripheral blood cells in patients who cleared HCV infection.

```{r data_eltahla_loading, echo=TRUE}
## Raw counts files were downloaded here:
## https://www.ebi.ac.uk/gxa/sc/experiments/E-MTAB-4850/downloads?geneId=ENSG00000107779

## loading data from Eltahla AA et al, 2016
## Counts matrix
rna <- readMM('../data/hcv/eltahla2016/E-MTAB-4850.aggregated_filtered_counts.mtx')
col_names <- readLines('../data/hcv/eltahla2016/E-MTAB-4850.aggregated_filtered_counts.mtx_cols') 
row_names <- read.table('../data/hcv/eltahla2016/E-MTAB-4850.aggregated_filtered_counts.mtx_rows')
rna <- as.matrix(rna)
colnames(rna) <- col_names
rownames(rna) <- row_names$V1
## Metadata
metadata <- read.table('../data/hcv/eltahla2016/E-MTAB-4850.sdrf.txt', 
                       sep = '\t', header = TRUE, stringsAsFactors = FALSE)
colnames(metadata) <- gsub('\\.', '', colnames(metadata))
metadata.s <- unique(select(metadata, 
                            CommentBioSD_SAMPLE, 
                            SourceName,
                            Characteristicscelltype))
```


```{r umap_vis}
rna_umap <- umap(t(rna), metric = 'cosine')
colnames(rna_umap) <- c('UMAP1', 'UMAP2')
rna_umap.df <- as.data.frame(rna_umap)
rna_umap.df <- mutate(rna_umap.df, id=col_names)
## length(intersect(metadata.s$CommentBioSD_SAMPLE, col_names)) ## check metatata intersection with colnames is unique
metadata.s <- rename(metadata.s, id=CommentBioSD_SAMPLE)
rna_umap.df <- merge(rna_umap.df, metadata.s)
rna_umap.df <- mutate(rna_umap.df, origin= gsub('[0-9]', '', SourceName))
rna_umap.df <- mutate(rna_umap.df, origin= trimws(origin))
ggplot(data = rna_umap.df) +
        geom_point(aes(UMAP1, UMAP2, colour=origin))
```

```{r rosemberg_data}
url_rosenmberg <- 'https://www.ncbi.nlm.nih.gov/geo/download/?acc=GSE119117&format=file&file=GSE119117%5Fcounts%5Fmatrix%2Etxt%2Egz'
if ( !file.exists('../data/hcv/rosemberg2018/rosemberg.gz')) {
       download.file(url = url_rosenmberg, 
                     destfile = '~/sc/singleCellDeconvolution//data/hcv/rosemberg2018/rosemberg.gz')       
}
bulk <- read.table('../data/hcv/rosemberg2018/rosemberg.gz')

## metadata 
## url https://www.ncbi.nlm.nih.gov/Traces/study/?acc=PRJNA488222&o=acc_s%3Aa
rosemberg_metadata <- read.csv('../data/hcv/rosemberg2018/rosemberg2018_metadata.csv')
rosemberg_metadata.s <- unique(select(rosemberg_metadata, Sample.Name, time_point))
series_matrix <- getGEO(filename="~/Downloads/GSE119117_series_matrix.txt")
sm <- data.frame(geo_acc=series_matrix$geo_accession, sample=series_matrix$`time point:ch1`,
                 id=series_matrix$title)
sm <- mutate(sm, id=gsub('-', '.', id))
```

```{r}
bulk_umap <- umap(t(bulk), metric = 'cosine')
bulk_umap.df <- as.data.frame(bulk_umap)
bulk_umap.df <- mutate(bulk_umap.df, id=colnames(bulk))
bulk_umap.df <- merge(bulk_umap.df, sm)
```


